<!DOCTYPE html>
<html lang="zh"><meta charset="utf-8"><meta name="generator" content="Hugo 0.88.1" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>åˆæ¢å†…å­˜æ³„éœ²&nbsp;&ndash;&nbsp;Chaoxin</title><link rel="stylesheet" href="/css/core.min.84c5e2b8068cddc84c7534071c5f6d5d6060d0d3c1ef7f7ffec918ab1a10597bd2a2f7017175bcb065819c8a953962e4.css" integrity="sha384-hMXiuAaM3chMdTQHHF9tXWBg0NPB739//skYqxoQWXvSovcBcXW8sGWBnIqVOWLk"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="åˆæ¢å†…å­˜æ³„éœ²" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><span class="site name">Chaoxin</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/categories/">åˆ†ç±»</a><a class="nav item" href="/tags/">æ ‡ç­¾</a><a class="nav item" href="/">å…¨éƒ¨æ–‡ç« </a><a class="nav item" href="http://github%2ecom/chao-x"target="_blank" rel="noopener noreferrer">Github</a></nav></div></span></div></section><section id="content"><div class="article-container">
    <div class="tocify">
        ğŸ—‚ç›®å½•

<ul class="toc-h2"><li><a href="/post/memory_leak/#1%e5%ae%9a%e4%b9%89">1.å®šä¹‰</a></li>
    <li><a href="/post/memory_leak/#2%e5%86%85%e5%ad%98%e6%b3%84%e9%9c%b2%e7%9a%84%e5%b8%b8%e8%a7%81%e5%8e%9f%e5%9b%a0">2.å†…å­˜æ³„éœ²çš„å¸¸è§åŸå› </a></li>
    <li><a href="/post/memory_leak/#3%e4%bd%bf%e7%94%a8pprof">3.ä½¿ç”¨pprof</a></li>
    
    <ul class="toc-h3"><li><a href="/post/memory_leak/#pprof%e4%bb%8b%e7%bb%8d">pprofä»‹ç»</a></li>
    <li><a href="/post/memory_leak/#%e5%bb%ba%e8%ae%ae%e6%8e%92%e6%9f%a5%e6%ad%a5%e9%aa%a4">å»ºè®®æ’æŸ¥æ­¥éª¤</a></li>
    
    <ul class="toc-h4"><li><a href="/post/memory_leak/#%e4%b8%80%e6%a3%80%e6%9f%a5%e4%bb%a3%e7%a0%81">ä¸€.æ£€æŸ¥ä»£ç </a></li>
    <li><a href="/post/memory_leak/#%e4%ba%8c%e6%9f%a5%e7%9c%8bgoroutine%e6%98%af%e5%90%a6%e6%b3%84%e9%9c%b2">äºŒ.æŸ¥çœ‹goroutineæ˜¯å¦æ³„éœ²</a></li>
    <li><a href="/post/memory_leak/#%e4%b8%89%e6%9f%a5%e7%9c%8b%e5%ae%9e%e6%97%b6%e5%86%85%e5%ad%98">ä¸‰.æŸ¥çœ‹å®æ—¶å†…å­˜</a></li>
    <li><a href="/post/memory_leak/#%e5%9b%9b%e6%9f%a5%e7%9c%8b%e7%b4%af%e7%a7%af%e5%86%85%e5%ad%98">å››.æŸ¥çœ‹ç´¯ç§¯å†…å­˜</a></li>
    
    </ul>
    </ul><li><a href="/post/memory_leak/#4%e5%86%85%e5%ad%98%e7%9b%91%e6%8e%a7">4.å†…å­˜ç›‘æ§</a></li>
    <li><a href="/post/memory_leak/#5%e6%9f%a5%e7%9c%8bgc">5.æŸ¥çœ‹GC</a></li>
    </div><section class="article header">
    <h1 class="article title">åˆæ¢å†…å­˜æ³„éœ²</h1><p class="article date">Tuesday, August 23, 2022<span class="reading-time"> â€¢ é¢„è®¡é˜…è¯»æ—¶é—´ 2 åˆ†é’Ÿ</span></p></section><article class="article markdown-body"><h2 id="1å®šä¹‰">1.å®šä¹‰</h2>
<p><strong>å†…å­˜æ³„éœ² memory leak</strong> ï¼Œæ˜¯æŒ‡ç¨‹åºåœ¨ç”³è¯·å†…å­˜åï¼Œæ— æ³•é‡Šæ”¾å·²ç”³è¯·çš„å†…å­˜ç©ºé—´ï¼Œä¸€æ¬¡å†…å­˜æ³„éœ²å±å®³å¯ä»¥å¿½ç•¥ï¼Œä½†æŒç»­ç´¯ç§¯ï¼Œå†…å­˜æ‰“æ»¡ä»¥åï¼ŒæœåŠ¡å°†ä¼šå´©æºƒã€‚</p>
<p><em>ç›‘æ§å®ä¾‹ï¼š</em></p>
<p><img  src="http://rte.weiyun.baidu.com/api/imageDownloadAddress?attachId=60810991bd67426faadc33c895f6c62d"
        alt/></p>
<p>æ­£å¸¸çš„å†…å­˜ç›‘æ§æ›²çº¿åº”è¯¥ç¨³å®šåœ¨ä¸€ä¸ªåŒºé—´å†…èµ·ä¼ã€‚è€Œå†…å­˜æ³„éœ²åï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå†…å­˜ä¸€ç›´éƒ½åœ¨ä¸Šæ¶¨ï¼Œåœ¨æ‰“æ»¡åï¼Œå®ä¾‹ç›´æ¥å´©æºƒé‡å¯ï¼Œç„¶ååˆé‡æ–°æ‰“æ»¡ï¼Œåˆé‡å¯ï¼Œå¦‚æ­¤å¾ªç¯ã€‚</p>
<h2 id="2å†…å­˜æ³„éœ²çš„å¸¸è§åŸå› ">2.å†…å­˜æ³„éœ²çš„å¸¸è§åŸå› </h2>
<ol>
<li>å…¨å±€å˜é‡åº”è¯¥é‡Šæ”¾çš„å†…å­˜æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œå…¨å±€å˜é‡çš„å†…å­˜ä¸€ç›´å¢é•¿(æ­£å¸¸åº”è¯¥æœ‰é‡Šæ”¾æœ‰å¢é•¿)ï¼Œå¦‚mapçš„kvä¸€ç›´åœ¨å¢åŠ ã€åˆ‡ç‰‡çš„é•¿åº¦ä¸€ç›´åœ¨å¢é•¿</li>
<li>éœ€è¦closeçš„å˜é‡æ²¡æœ‰è¢«å…³é—­ï¼Œå¦‚http é“¾æ¥ã€mysqlé“¾æ¥</li>
<li>goroutine æ³„éœ²ï¼ŒåŸæœ¬åº”è¯¥ç»“æŸçš„goroutineæ²¡æœ‰ç»“æŸï¼Œå¯¼è‡´å¯¹åº”çš„å†…å­˜æ— æ³•è¢«é‡Šæ”¾</li>
<li>Cgo ç›¸å…³çš„å†…å­˜æ³„éœ²ï¼Œåœ¨Goé‡Œä½¿ç”¨Cgoï¼ŒCä»£ç åˆ†é…çš„å†…å­˜æ˜¯æ— æ³•è¢«Goçš„GCç®¡ç†çš„ï¼Œä¹Ÿæ— æ³•è¢«pprofè¿½è¸ª</li>
</ol>
<h2 id="3ä½¿ç”¨pprof">3.ä½¿ç”¨pprof</h2>
<h3 id="pprofä»‹ç»">pprofä»‹ç»</h3>
<p>pprofæ˜¯ Go è¯­è¨€ä¸­åˆ†æç¨‹åºè¿è¡Œæ€§èƒ½çš„å·¥å…·ï¼Œå®ƒèƒ½æä¾›å„ç§æ€§èƒ½æ•°æ®ï¼š</p>
<p><img  src="http://rte.weiyun.baidu.com/api/imageDownloadAddress?attachId=65677d01b08641699f15b6e9022416a5"
        alt/></p>
<h3 id="å»ºè®®æ’æŸ¥æ­¥éª¤">å»ºè®®æ’æŸ¥æ­¥éª¤</h3>
<h4 id="ä¸€æ£€æŸ¥ä»£ç ">ä¸€.æ£€æŸ¥ä»£ç </h4>
<p>æŸ¥çœ‹å…¨å±€å˜é‡æ˜¯å¦æœ‰å¯ç–‘é€»è¾‘ï¼Œå¯¼è‡´å…¨å±€å˜é‡å†…å­˜ä¸æ–­å¢é•¿</p>
<p>æŸ¥çœ‹æ˜¯å¦æœ‰æ²¡æœ‰å…³é—­çš„<em><strong>close</strong></em></p>
<p>æŸ¥çœ‹<strong>Cgo</strong> <strong>ç›¸å…³ä»£ç </strong>ï¼Œå¦‚CStringçš„å†…å­˜æœ‰æ²¡æœ‰è¢«é‡Šæ”¾</p>
<hr>
<p><strong>å®ä¾‹ï¼š</strong> å‡½æ•°ä½¿ç”¨CStringåŒ¿åå‚æ•°ï¼Œä¹Ÿä¼šå¯¼è‡´å†…å­˜æ³„éœ²</p>
<p>é—®é¢˜ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">ret</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">get_shmdict_value</span><span class="p">(</span><span class="nx">C</span><span class="p">.</span><span class="nf">CString</span><span class="p">(</span><span class="nx">file</span><span class="p">),</span> <span class="nx">C</span><span class="p">.</span><span class="nf">CString</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">content</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">40960</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">errmsg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1024</span><span class="p">)</span>
</code></pre></div><p>ä¿®å¤åï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">cfile</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">CString</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
<span class="nx">ckey</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">CString</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="nx">ret</span> <span class="o">:=</span> <span class="nx">C</span><span class="p">.</span><span class="nf">get_shmdict_value</span><span class="p">(</span><span class="nx">cfile</span><span class="p">,</span> <span class="nx">ckey</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">content</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">40960</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">errmsg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1024</span><span class="p">)</span>
<span class="nx">C</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">cfile</span><span class="p">))</span>
<span class="nx">C</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">ckey</span><span class="p">))</span>
</code></pre></div><hr>
<p>ç­‰ç­‰å…¶ä»–å¯èƒ½é€ æˆå†…å­˜æ³„éœ²çš„ä»£ç </p>
<h4 id="äºŒæŸ¥çœ‹goroutineæ˜¯å¦æ³„éœ²">äºŒ.æŸ¥çœ‹goroutineæ˜¯å¦æ³„éœ²</h4>
<p>å‹æµ‹è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ <em><strong>pprof</strong></em> ï¼Œè®¿é—® ï¼ˆå¯¹åº”çš„IPå’Œç«¯å£ï¼‰<a href="http://10.12.205.56:8305/debug/pprof/goroutine?debug=1"target="_blank" rel="noopener noreferrer">http://127.0.0.1:8305/debug/pprof/goroutine?debug=1</a>
</p>
<p>æŸ¥çœ‹goroutineæ•°é‡æ˜¯å¦ç¨³å®šåœ¨ä¸€ä¸ªåŒºé—´ï¼š</p>
<p>å¦‚æœgoroutineä¸æ–­å¢é•¿ï¼Œç¡®å®šä¸º<em><strong>goroutine</strong></em><strong>æ³„éœ²</strong></p>
<h4 id="ä¸‰æŸ¥çœ‹å®æ—¶å†…å­˜">ä¸‰.æŸ¥çœ‹å®æ—¶å†…å­˜</h4>
<p>å‹æµ‹è¿‡ç¨‹ä¸­ï¼Œå½“å†…å­˜è¾¾åˆ°ä¸€ä¸ªé«˜å€¼ä»¥åï¼Œä½¿ç”¨å‘½ä»¤ ï¼ˆå¯¹åº”IPå’Œç«¯å£ï¼‰</p>
<p>ç”Ÿæˆå®æ—¶å†…å­˜æ•°æ®ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">go tool pprof http://127.0.0.1:8080/debug/pprof/heap?debug<span class="o">=</span><span class="m">1</span>
</code></pre></div><p>å®‰è£…å¹¶ä½¿ç”¨graphviz ç»˜åˆ¶å¯¹åº”çš„å›¾å½¢</p>
<p>ä½¿ç”¨å‘½ä»¤ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">go tool pprof http://127.0.0.1:8080/debug/pprof/heap?debug<span class="o">=</span><span class="m">1</span>
</code></pre></div><p>è®¿é—® <a href="http://127.0.0.1:8090/ui"target="_blank" rel="noopener noreferrer">http://127.0.0.1:8090/ui</a>
 æŸ¥çœ‹å†…å­˜è·¯çº¿å›¾å’Œç«ç„°å›¾ï¼Œå¸®åŠ©å®šä½é—®é¢˜</p>
<p>ç«ç„°å›¾çš„æŸ¥çœ‹æ–¹æ³•ä¸ºï¼šä»ä¸Šåˆ°ä¸‹ä¸ºè°ƒç”¨é“¾è·¯ï¼Œå·¦å³é—´è·è¶Šå¤§æ ‡è¯†å ç”¨å†…å­˜è¶Šå¤š</p>
<h4 id="å››æŸ¥çœ‹ç´¯ç§¯å†…å­˜">å››.æŸ¥çœ‹ç´¯ç§¯å†…å­˜</h4>
<p>å¦‚æœå®æ—¶å†…å­˜æ— æ³•å®šä½é—®é¢˜ï¼Œå¯ä»¥æŸ¥çœ‹ç´¯ç§¯æ—¶é—´ç”³è¯·çš„å†…å­˜ï¼Œå¸®åŠ©å®šä½é—®é¢˜</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">go tool pprof http://127.0.0.1:8080/debug/pprof/heap -seconds <span class="m">30</span>
</code></pre></div><h2 id="4å†…å­˜ç›‘æ§">4.å†…å­˜ç›‘æ§</h2>
<p>æ²¡æœ‰å¯¹åº”çš„å†…å­˜ç›‘æ§å·¥å…·ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">ps aux <span class="p">|</span> grep å¯¹åº”pid
</code></pre></div><p>æŸ¥çœ‹<strong>RSS</strong>æŸ¥çœ‹å®æ—¶å ç”¨å†…å­˜</p>
<h2 id="5æŸ¥çœ‹gc">5.æŸ¥çœ‹GC</h2>
<p>æŸ¥çœ‹GCæ˜¯å¦æ­£å¸¸ï¼Œä½¿ç”¨å‘½ä»¤</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">GODEBUG</span><span class="o">=</span><span class="nv">gctrace</span><span class="o">=</span><span class="m">1</span> go run main.go
</code></pre></div></article><section class="article labels"><a class="category" href=/categories/go/>go</a><a class="tag" href=/tags/go/>go</a><a class="tag" href=/tags/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/>å†…å­˜æ³„éœ²</a></section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/post/writing_skill/"><span class="iconfont icon-article"></span>åšç¬”è®°çš„å¿ƒå¾—ä½“ä¼š</a></p></section><section class="article discussion"><div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "chaoxin-site" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">Â©2022 Chaoxin.</p>
    <p class="powerby"><span>Powered&nbsp;by&nbsp;</span><a href="https://gohugo.io" 
        target="_blank" rel="noopener noreferrer">Hugo</a><span>&nbsp;&amp;&nbsp;</span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank" rel="noopener noreferrer">Notepadium</a>
<a href='https://ipv6-test.com/validate.php?url=referer'
  ><img src='https://ipv6-test.com/button-ipv6-80x15.png' 
        alt='ipv6 ready' title='ipv6 ready' border='0' 
/></a>
</p></div>
</section><script src="/js/hljs.min.72e76ccf211868d08e31d7ca45c02501991bd760f28809c52045fa79fb7b7428664bb54ae875b46031ebc760c77b9562.js" integrity="sha384-cudszyEYaNCOMdfKRcAlAZkb12DyiAnFIEX6eft7dChmS7VK6HW0YDHrx2DHe5Vi"></script><script>hljs.initHighlightingOnLoad();</script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-47315632-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script src="/js/core.min.9f370520a66bbb5abf9da80de13b900f5ac7b2b7d9f65b4cad6222af5640db998bd09c07cf4e89324bc074507c527517.js" integrity="sha384-nzcFIKZru1q/nagN4TuQD1rHsrfZ9ltMrWIir1ZA25mL0JwHz06JMkvAdFB8UnUX"></script></body>

</html>